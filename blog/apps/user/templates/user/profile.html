{% extends 'layout.html' %}

{% block content %}
<div class="relative flex flex-col items-center gap-8 mt-16 md:flex-row md:justify-center md:items-start">
  <!-- Perfil -->
  <div class="w-full max-w-md bg-white dark:bg-gray-800 border-2 border-indigo-600 rounded-xl shadow-lg p-6 text-center">
    <h1 class="text-3xl md:text-4xl font-base text-indigo-600 mb-4 drop-shadow select-none">{{ title }}</h1>
    <h2 class="text-xl md:text-2xl font-bold text-indigo-600 mb-6">¡Hola, {{ request.user.username }}!</h2>

    <div class="w-32 h-32 mx-auto mb-6 relative">
      <img src="{{ comentario.author.profile.avatar.url }}?{{ comentario.author.profile.updated_at.timestamp }}" alt="Avatar"
        class="rounded-full w-32 h-32 object-cover mx-auto border-2 border-indigo-600 shadow select-none" />
    </div>

    <p class="text-gray-700 dark:text-gray-200 mb-6 text-lg">Estás conectado a tu cuenta.</p>

    <form action="{% url 'user:password_change' %}" method="get" class="mb-4">
      <button type="submit"
        class="bg-indigo-700 text-white font-semibold py-2 px-6 rounded hover:bg-indigo-900 transition-colors cursor-pointer text-lg w-full">
        Cambiar contraseña
      </button>
    </form>

    <button id="toggle-edit-profile"
      class="bg-indigo-700 text-white font-semibold py-2 px-6 rounded hover:bg-indigo-900 transition-colors cursor-pointer text-lg w-full">
      Editar perfil
    </button>
  </div>

  <!-- Formulario de edición -->
  <div id="edit-profile-form"
       class="absolute top-0 left-0 w-full md:static md:w-auto max-w-md bg-white dark:bg-gray-800 border-2 border-indigo-600 rounded-xl shadow-lg p-6 text-center hidden z-10">
    
    <!-- Volver atrás (solo móvil) -->
    <div class="absolute top-4 left-4 text-indigo-600 font-semibold cursor-pointer hover:underline z-20 block md:hidden" id="back-text">
      ← Volver atrás
    </div>

    <form action="." method="post" enctype="multipart/form-data" class="mt-8">
      {% csrf_token %}

      <!-- Avatar editable -->
      <div class="w-32 h-32 mx-auto mb-2 relative cursor-pointer" id="avatar-container">
        <img id="avatar-image" src="{{ request.user.profile.avatar.url }}" alt="Avatar"
          class="rounded-full w-32 h-32 object-cover mx-auto border-2 border-indigo-600 shadow transition hover:ring-4 hover:ring-indigo-400" />
      </div>
      <p class="text-xs text-gray-500 dark:text-gray-400 mb-6">Haz clic en la imagen para cambiar tu avatar</p>

      <!-- Input oculto para avatar -->
      <input type="file" name="{{ avatar_form.avatar.name }}" id="id_avatar" class="hidden" />

      {{ form.as_p }}

      <input type="submit" value="Guardar cambios"
        class="bg-indigo-700 text-white font-semibold py-2 px-6 rounded hover:bg-indigo-900 transition-colors cursor-pointer mt-4 w-full text-lg" />
    </form>
  </div>
</div>

<script>
  // Toggle formulario editar perfil
  const toggleButton = document.getElementById('toggle-edit-profile');
  const editForm = document.getElementById('edit-profile-form');
  const backText = document.getElementById('back-text');

  toggleButton.addEventListener('click', () => {
    editForm.classList.toggle('hidden');
    toggleButton.textContent = editForm.classList.contains('hidden') 
      ? 'Editar perfil' 
      : 'Cerrar edición';
  });

  backText.addEventListener('click', () => {
    editForm.classList.add('hidden');
    toggleButton.textContent = 'Editar perfil';
  });

  // Avatar editable solo dentro del formulario
  const avatarImage = document.getElementById('avatar-image');
  const avatarContainer = document.getElementById('avatar-container');
  const fileInput = document.getElementById('id_avatar');

  avatarContainer.addEventListener('click', () => {
    fileInput.click();
  });

  fileInput.addEventListener('change', () => {
    const [file] = fileInput.files;
    if (file) {
      avatarImage.src = URL.createObjectURL(file);
    }
  });
</script>
{% endblock %}
